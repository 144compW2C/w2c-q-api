name: ğŸš€ VPS Deploy & Discord Notification

on:
    push:
        branches: [main]

jobs:
    deploy:
        name: ğŸ”„ Deploy to VPS
        runs-on: ubuntu-latest

        steps:
            # â‘  Checkout repository
            - name: ğŸ“¥ Checkout Repository
              uses: actions/checkout@v3

            # â‘¡ Install sshpass for password authentication
            - name: ğŸ”§ Install sshpass
              run: sudo apt-get update && sudo apt-get install -y sshpass

            # â‘¢ Upload .env file to VPS
            - name: ğŸ“¨ Upload .env to VPS
              run: |
                  echo "${{ secrets.ENV_FILE }}" > .env
                  sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'mkdir -p ~/w2c-q-api'
                  sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no .env ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:~/w2c-q-api/.env

            # â‘£ Deploy to VPS
            - name: ğŸš€ Deploy Rails API
              run: |
                  sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
                    BRANCH=$(echo "${{ github.ref }}" | sed 's|refs/heads/||')

                    echo "ğŸ“ Preparing w2c-q-api directory..."
                    if [ ! -d "$HOME/w2c-q-api/.git" ]; then
                      echo "âš ï¸ .git does not exist â†’ Removing folder and cloning fresh"
                      rm -rf $HOME/w2c-q-api
                      git clone https://github.com/${{ github.repository }} $HOME/w2c-q-api
                    else
                      echo "ğŸ“¥ Updating existing repository (git pull)..."
                      cd $HOME/w2c-q-api
                      git reset --hard
                      git clean -fd
                      git pull origin $BRANCH
                    fi

                    echo "ğŸ“‚ Navigating to w2c-q-api directory..."
                    cd $HOME/w2c-q-api

                    echo "ğŸ›‘ Stopping and removing old containers..."
                    docker compose down

                    echo "ğŸ§¹ Cleaning up old images..."
                    docker compose rm -f

                    echo "ğŸ³ Building and starting fresh containers..."
                    docker compose up -d --build --force-recreate

                    echo "â³ Waiting for services to be ready..."
                    sleep 15

                    echo "ğŸ—„ï¸ Running database migrations..."
                    docker compose exec -T web rails db:create db:migrate

                    echo "ğŸŒ± Seeding database..."
                    docker compose exec -T web rails db:seed

                    echo "âœ… Fresh deployment completed!"

                    echo "âœ… Deployment completed successfully!"
                  EOF

    # â‘¤ Success notification
    notify-success:
        needs: deploy
        if: success()
        runs-on: ubuntu-latest
        steps:
            - name: âœ… Discord Notification (Success)
              run: |
                  curl -X POST -H "Content-Type: application/json" \
                  -d '{
                    "content": "<@852754282812801024> <@774622976342753300>\n**âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼**\nğŸ“¦ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}\nğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}\nğŸ‘¤ å®Ÿè¡Œè€…: ${{ github.actor }}"
                  }' ${{ secrets.DISCORD_WEBHOOK_URL }}

    # â‘¥ Failure notification
    notify-failure:
        needs: deploy
        if: failure()
        runs-on: ubuntu-latest
        steps:
            - name: âŒ Discord Notification (Failure)
              run: |
                  curl -X POST -H "Content-Type: application/json" \
                  -d '{
                    "content": "<@852754282812801024> <@774622976342753300>\n**âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼**\nğŸ“¦ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}\nğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}\nğŸ‘¤ å®Ÿè¡Œè€…: ${{ github.actor }}"
                  }' ${{ secrets.DISCORD_WEBHOOK_URL }}
